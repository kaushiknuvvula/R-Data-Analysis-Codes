---
title: "HW_1_Kaushik"
author: "KK"
date: "September 29, 2015"
output: pdf_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r,echo=FALSE}
chicago = readRDS("C:/Users/Kaushik Nuvvula/Desktop/EDA/HW_1/Chicago.rds")
```

##2
# Installing all required packages
```{r}
#local({r <- getOption("repos"); 
#       r["CRAN"] <- "http://cran.r-project.org"; options(repos=r)})
#install.packages("dplyr")
library("dplyr")
#install.packages('Hmisc')
library("Hmisc")
#install.packages("VIM")
library(VIM)


#install.packages("mice")
library(mice)

#install.packages("corrplot")
library(corrplot)

#install.packages("PerformanceAnalytics")
library(PerformanceAnalytics)


chicago =tbl_df(chicago)
#gives the structure of the data along with the datatypes
str(chicago)

#colnames(chicago)
# tmpd	dptp	date	pm25tmean2	pm10tmean2	o3tmean2	no2tmean2

#visually detecting missing values
#aggr function displays the number of missing values and also the number of collectively missing values
aggr(chicago, prop=FALSE, numbers=TRUE)

#Plots a color matrix, representing the values stored in the chicago dataset 
matrixplot(chicago[,c(2:8)])

# We see that there are many missing values. let us get a count of them first
sum(is.na(chicago$tmpd)) # 4% of the values are missing
sum(is.na(chicago$dptp))
sum(is.na(chicago$date))
sum(is.na(chicago$pm25tmean2)) # 60-70% of the values are missing. Which is huge and makes it more intersting
sum(is.na(chicago$pm10tmean2)) # 4% of the values are missing
sum(is.na(chicago$o3tmean2))
sum(is.na(chicago$no2tmean2))

#Imputing missing values. Let us follow three procedures and choose the best one.

#Procedure_1: Imputing median into the missing values
#Defining a fucntion to impute median into the missing values

median_imputed_data = chicago

impute_median = function (a){
  missing = is.na(a)
  imputed = a
  imputed[missing] = median(a,  na.rm=TRUE) # Replace median where the value is missing
  return (imputed)
}
# Testing the median function
k=as.numeric (c("1", "2", "5","three", "4"))
impute_median(k)

#Imputing the median by calling the fucntion
median_imputed_data$pm25tmean2 = impute_median(median_imputed_data$pm25tmean2)
median_imputed_data$pm10tmean2 = impute_median(median_imputed_data$pm10tmean2)
median_imputed_data$tmpd = impute_median(median_imputed_data$tmpd)
median_imputed_data$dptp = impute_median(median_imputed_data$dptp)

# Now see if there are missing values. Visually plotting
aggr(median_imputed_data, prop=FALSE, numbers=TRUE)

#Procedure_2: Imputing missing values using mice package

chicago1 = chicago[,c(2,3,5,6,7,8)]

imp=mice(chicago1, seed=1234)
fit= with(imp,lm(chicago1$pm25tmean2 ~chicago1$pm10tmean2 + chicago1$no2tmean2 ))
pooled = pool(fit)
summary(pooled)

mice_imputed_data = complete(imp, action=3)

# Imputing values retaining the date 
chicago_date=chicago
chicago_date$date <- as.numeric(chicago_date$date)
chicago_date=chicago_date[,c(2,3,4,5,6,7,8)]
imp=mice(chicago_date, seed=1234)
fit= with(imp,lm(chicago_date$pm25tmean2 ~chicago_date$pm10tmean2 + chicago_date$no2tmean2 ))
pooled = pool(fit)
summary(pooled)

mice_imputed_data_date = complete(imp, action=3)


# Now see if there are missing values. Visually plotting
aggr(mice_imputed_data, prop=FALSE, numbers=TRUE)

#Procedure_3: Ignoring and removing the missing values

ignore_missing_data = chicago

# This fucntion removes rows based on Nas in columns  
missing_fun = function(data, desiredCols) {
  completeVec = complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}   

#Removing rows 
ignore_missing_data =  missing_fun(chicago, "pm25tmean2")

#Checking for missing values. We still see that there are 1 or 2 values missing. Replacing them median
ignore_missing_data$pm10tmean2 = impute_median(ignore_missing_data$pm10tmean2)
ignore_missing_data$tmpd = impute_median(ignore_missing_data$tmpd)
ignore_missing_data$dptp = impute_median(ignore_missing_data$dptp)

# Now see if there are missing values. Visually plotting
aggr(ignore_missing_data, prop=FALSE, numbers=TRUE)

# Now let us comapre the variation in the variables imputed using the three methods.
#Let us check the box plots to see if any outlier treatment has to be done

old.par = par(mfrow=c(1, 4))

boxplot(median_imputed_data$pm25tmean2,median_imputed_data$pm10tmean2,median_imputed_data$o3tmean2,median_imputed_data$no2tmean2,
        names=c("PM25","PM10","O3","NO2"),col=c("blue","tomato"),
        main="Median Imputed Data",outer = TRUE)

boxplot(mice_imputed_data$pm25tmean2,mice_imputed_data$pm10tmean2,mice_imputed_data$o3tmean2,mice_imputed_data$no2tmean2,
        names=c("PM25","PM10","O3","NO2"),col=c("blue","tomato"),  main="Mice Imputed Data ",outer = TRUE)

boxplot(ignore_missing_data$pm25tmean2,ignore_missing_data$pm10tmean2,ignore_missing_data$o3tmean2,ignore_missing_data$no2tmean2,
        names=c("PM25","PM10","O3","NO2"),col=c("blue","tomato"), ylim=c(0,370),  main="PM25 Missing Removed ",outer = TRUE)

boxplot(chicago$pm25tmean2,chicago$pm10tmean2,chicago$o3tmean2,chicago$no2tmean2,
        names=c("PM25","PM10","O3","NO2"),col=c("blue","tomato"),  main="Original Untouched Dataset",outer = TRUE)

par(old.par)

#Checking the how the correlation factors changes on these 3 datasets

mice_cor = cor(mice_imputed_data)
par(oma=c(0,0,2,0)) # Specifying the outer margins

med_imp = cor(median_imputed_data[,c(2,3,5,6,7,8)])
par(oma=c(0,0,2,0))

missing_rem =cor(ignore_missing_data[,c(2,3,5,6,7,8)])
par(oma=c(0,0,2,0))

#arranging the correlation plots side by side
old.par = par(mfrow=c(1, 3))
corrplot(mice_cor, method = "number",title = 'Mice Imputed Data                   Median Imputed Data                        Ignore Missing Data',outer=TRUE)

corrplot(med_imp, method = "number",outer=TRUE)

corrplot(missing_rem, method = "number",outer=TRUE)

par(old.par)

# One important observation is that after imputing the values the correlation coeffcients are almost the same
# Looking at the summary stats
summary(median_imputed_data)
summary(ignore_missing_data)
summary(mice_imputed_data)
summary(chicago)

#Chossing the best data set in this case
#From the correlation plot and summary we can infer that mice dataset is closest to the actual data.
#However mice predicts the missing values using a linear relationship and multiple iterations.
#Assumption: The data is missing. Not that missing data is not captured. 
#As we see the data b/w 1987 and 1998 for PM25 variable is missing. As PM25 captures 70% of data we cannot risk to ignore it as we will be lsoing valuable information.
#So using the Mice imputed data might be ideal. Imputing median might bias our analysis towards median as 70% of PM25 data is missing

#Visualization of a Correlation Matrix. 
#On top the (absolute) value of the correlation plus the result of the cor.test as stars. On bottom, the bivariate scatterplots, with a fitted line
#chart.Correlation(mice_cor, histogram=TRUE)

"Certain Outlier treatment has been done for 'pm25tmean2' values in the next question after interpreting
'seemingly high' value of PM2.5"

##3

sub_pm25=arrange(mice_imputed_data, desc(pm25tmean2))
head(sub_pm25,n = 10)

summary(mice_imputed_data)

#Checking the quintile distribution
quantile(mice_imputed_data$pm25tmean2,probs=seq(0,1,by=.01)) # checking the quintile distribution


#Spotting the outliers in PM25 using a box plot
#boxplot(mice_imputed_data$pm25tmean2,mice_imputed_data$pm10tmean2,
#        names=c("PM25"),col=c("tomato","blue"),name="PM25 and PM10")

#mean_1 = mean(mice_imputed_data$pm25tmean2)#mean is 18.1
#sd_1 = sd(mice_imputed_data$pm25tmean2) #sd is 9.95 

#There are certain observations which are 4 sds greater than mean, they can be replaced with median instead deleting them and losing information 
# However since 61.5 is not very far off from 56.5, we can retain these values without making any changes
#mice_imputed_data$pm25tmean2[mice_imputed_data$pm25tmean2>(mean_1 + 4*sd_1)] = median(mice_imputed_data$pm25tmean2)

# Now look at the top 10 values of PM10
a=arrange(mice_imputed_data, desc(pm10tmean2))
head(a,n = 10)

#Let us also look at PM10
mean_2 = mean(mice_imputed_data$pm10tmean2)#mean is 33.89
sd_2 = sd(mice_imputed_data$pm10tmean2) #sd is 17.95 
quantile(mice_imputed_data$pm10tmean2,probs=seq(0,1,by=.05)) # checking the quintile distribution

#Replacing the top two observations (treat them as outleirs) which are way away more than 10 standard deviations from mean with median
mice_imputed_data_date$pm10tmean2[mice_imputed_data_date$pm10tmean2>(150)] = median(mice_imputed_data_date$pm10tmean2)

#Cross Check PM10 now
a=arrange(mice_imputed_data_date, desc(pm10tmean2))
head(a,n = 10)

#All other variables look fine without any outliers. Hence we can further proceed with our analysis.

##4
#Looking and at the correlation plot to find dependencies
corrplot(mice_cor, method = "number",title = 'Mice Imputed Data', outer=TRUE)

#From the correlation plot we see that for high values of PM25, PM10 and NO2 values are also high (all of them greater than 95%ile)
head(sub_pm25,n = 10)

#Top 10 values of No2
sub_no2=arrange(mice_imputed_data, desc(no2tmean2))
head(sub_no2,n = 10)

#Top 10 values of PM10
sub_pm10=arrange(mice_imputed_data, desc(pm10tmean2))
head(sub_pm10,n = 10)

quantile(mice_imputed_data$pm10tmean2,probs=seq(0,1,by=.05))

quantile(mice_imputed_data$no2tmean2,probs=seq(0,1,by=.05))


##5

#Z score normalization
y = mice_imputed_data_date$pm25tmean2
mice_imputed_data_N_PM25 = mice_imputed_data_date
#Normalized Data
mice_imputed_data_N_PM25$pm25_N = (y-mean(y))/(sd(y))

#min-max normalization
x = mice_imputed_data_date$pm10tmean2

#Normalized Data
mice_imputed_data_N_PM25$pm10_N = (x-min(x))/(max(x)-min(x))
mice_imputed_data_N =mice_imputed_data_N_PM25

##6
#year = as.POSIXlt(chicago_new_N$date)$year + 1900

mice_imputed_data_N$date <- as.Date(mice_imputed_data_N$date)

mice_imputed_data_N[c("year")] = as.POSIXlt(mice_imputed_data_N$date)$year + 1900

##7
aggregate(cbind(dptp,tmpd,pm10tmean2,o3tmean2,no2tmean2)~year,
          data = mice_imputed_data_N,
          FUN=function(x){summary(x)})

##8


#We see that as PM25 and avg_o3 are not following any pattern

pm25.quint <- cut(mice_imputed_data_N$pm25tmean2,breaks=c(quantile(mice_imputed_data_N$pm25tmean2,
                                                                   probs = seq(0, 1, by = 0.10))),
                  labels=c("0-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100"), 
                  include.lowest=TRUE)

mice_imputed_data_final <- cbind(mice_imputed_data_N,pm25.quint)
grp_by <- group_by(mice_imputed_data_final,pm25.quint)
summarise(grp_by,avg_o3tmean2 = mean(o3tmean2))





```

